name: Issue
on:
  issue_comment:
    types: [created]

jobs:
  approval:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '[testpypi]') && (github.event.comment.author_association == 'OWNER' || github.event.comment.author_association == 'COLLABORATOR')
    steps:
      - name: Dump GitHub Context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: Validate Status
        run: |
          html_url="${{ github.event.issue.html_url }}"
          pr_url="https://github.com/${{ github.repository }}/pull"
          is_pr="$(python -c 'print("$html_url".startswith("$pr_url"))')"
          if [ "$is_pr" = "True" ]; then
            if [ "${{ github.event.issue.state }}" = "closed" ]; then
              # Add a comment to the issue indicating [testpypi] only triggers
              # for open pull requests.
              curl -X POST \
                   --url '${{ github.event.issue.comments_url }}' \
                   -H 'Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
                   -H 'Content-Type: application/json' \
                   -d '{"body": ":scream: `[testpypi]` only runs on open pull requests!"}'
            else
              curl -X POST \
                   --url '${{ github.event.issue.comments_url }}' \
                   -H 'Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
                   -H 'Content-Type: application/json' \
                   -d '{"body": ":scream: :boom: :alien: :boom: :scream:"}'
              curl -X POST \
               --url 'https://api.github.com/repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions' \
               -H 'Accept: application/vnd.github.squirrel-girl-preview' \
               -H 'Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
               -H 'Content-Type: application/json' \
               -d '{"content": "rocket"}'
            fi
          fi
